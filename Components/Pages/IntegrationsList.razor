@page "/"
@page "/app/integrations"
@rendermode InteractiveServer

@inject HttpClient Http
@inject NavigationManager Nav

<h1 class="page-title">Integrations</h1>
<div class="page-subtitle">
    Manage and run your integration configurations.
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}
else if (isLoading)
{
    <p>Loading configurations...</p>
}
else if (names.Count == 0)
{
    <p>No configurations found yet.</p>
}
else
{
    <div class="panel">
        <div class="panel-header">
            <div>
                <div class="panel-title">Existing integrations</div>
                <div class="panel-subtitle">Click to edit, duplicate or remove.</div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th class="col-narrow">Actions</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var name in names)
            {
                <tr>
                    <td>@name</td>
                    <td>
                        <div style="display:flex; gap:0.25rem;">
                            <a class="btn-primary btn-sm" href="@AppRoutes.EditIntegration(name)">
                                Open
                            </a>
                            <button class="btn-ghost btn-sm"
                                    type="button"
                                    @onclick="() => DuplicateAsync(name)">
                                Duplicate
                            </button>
                            <button class="btn-ghost btn-sm"
                                    type="button"
                                    @onclick="() => DeleteAsync(name)">
                                Remove
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
}

<p class="mt-3">
    <a class="btn-secondary" href="@AppRoutes.EditIntegration("NewIntegration")">
        + New integration
    </a>
</p>

@code {
    private List<string> names = new();
    private bool isLoading = true;
    private string? errorMessage;

    private Uri BuildApiUri(string relativePath)
    {
        var baseUri = new Uri(Nav.BaseUri);
        return new Uri(baseUri, relativePath.TrimStart('/'));
    }

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task DuplicateAsync(string sourceName)
    {
        errorMessage = null;

        try
        {
            var newName = sourceName + "_Copy";

            var url = BuildApiUri(ApiRoutes.DuplicateIntegration);
            var response = await Http.PostAsJsonAsync(url,
                new DuplicateIntegrationRequest
                {
                    SourceName = sourceName,
                    TargetName = newName
                });

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error duplicating integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            await ReloadAsync();
            NotificationService.Instance.ShowSuccess("Integration duplicated", $"Copied '{sourceName}' to '{newName}'.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while duplicating integration: {ex.Message}";
            NotificationService.Instance.ShowError("Duplicate failed", errorMessage);
        }
    }

    private async Task DeleteAsync(string name)
    {
        errorMessage = null;

        try
        {
            var url = BuildApiUri(ApiRoutes.Integration(name));
            var response = await Http.DeleteAsync(url);

            if (!response.IsSuccessStatusCode && response.StatusCode != System.Net.HttpStatusCode.NoContent)
            {
                errorMessage = $"Error deleting integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            await ReloadAsync();
            NotificationService.Instance.ShowSuccess("Integration removed", $"Deleted '{name}'.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while deleting integration: {ex.Message}";
            NotificationService.Instance.ShowError("Delete failed", errorMessage);
        }
    }

    private async Task ReloadAsync()
    {
        isLoading = true;

        try
        {
            var url = BuildApiUri(ApiRoutes.IntegrationsBase);
            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Backend returned {(int)response.StatusCode} {response.ReasonPhrase} while calling {url}.";
                NotificationService.Instance.ShowError("Load failed", errorMessage);
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<List<string>>();
            names = result ?? new List<string>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while reloading integrations: {ex.Message}";
            NotificationService.Instance.ShowError("Load failed", errorMessage);
        }
        finally
        {
            isLoading = false;
        }
    }
}
