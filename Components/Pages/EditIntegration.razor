@page "/app/integrations/edit/{Name?}"
@rendermode InteractiveServer

@using MIBO.Models
@using MIBO.Components.Integration

@inject HttpClient Http
@inject NavigationManager Nav

<h1 class="page-title">Edit integration</h1>
<div class="page-subtitle">
    Configure the source and target calls and define field mappings.
</div>

<div class="mb-3">
    <a href="/app/integrations" class="btn-ghost">
        ‚Üê Back to list
    </a>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

@if (isLoading)
{
    <div>Loading...</div>
}
else
{
    <IntegrationConfigPanel Config="Config" />

    <SourceApiPanel Config="Config" />

    <TargetApiPanel Config="Config" />

    <MappingPanel Mappings="Config.Mappings"
                  OnAddMapping="AddMapping"
                  OnRemoveMapping="RemoveMapping" />

    <div class="mt-3">
        <button type="button"
                class="btn-secondary"
                @onclick="SaveAsync"
                disabled="@isSaving">
            @(isSaving ? "Saving..." : "Save configuration")
        </button>

        <button type="button"
                class="btn-primary"
                @onclick="RunAsync"
                disabled="@isRunning">
            @(isRunning ? "Running..." : "Save & run source call")
        </button>
    </div>

    <ApiResultPanel ApiResult="ApiResult"
                    MappedJson="MappedJson" />
}

@code {
    [Parameter] public string? Name { get; set; }

    private IntegrationConfig Config { get; set; } = new();
    private ApiCallResult? ApiResult { get; set; }
    private string? MappedJson { get; set; }

    private bool isLoading = true;
    private bool isSaving;
    private bool isRunning;
    private string? errorMessage;

    private Uri BuildApiUri(string relativePath)
    {
        var baseUri = new Uri(Nav.BaseUri);
        return new Uri(baseUri, relativePath.TrimStart('/'));
    }

    protected override async Task OnInitializedAsync()
    {
        var nameToLoad = string.IsNullOrWhiteSpace(Name) ? "NewIntegration" : Name;

        try
        {
            var url = BuildApiUri($"api/integrations/{nameToLoad}");
            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error loading integration '{nameToLoad}': {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            var loaded = await response.Content.ReadFromJsonAsync<IntegrationConfig>();
            Config = loaded ?? new IntegrationConfig { Name = nameToLoad };

            // üî¥ BELANGRIJK: mappinglijst nooit null
            Config.Mappings ??= new List<FieldMapping>();
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while loading integration '{nameToLoad}': {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AddMapping()
    {
        Config.Mappings ??= new List<FieldMapping>();
        Config.Mappings.Add(new FieldMapping());
    }

    private void RemoveMapping(int index)
    {
        if (Config.Mappings is null) return;
        if (index < 0 || index >= Config.Mappings.Count) return;

        Config.Mappings.RemoveAt(index);
    }

    private async Task SaveAsync()
    {
        isSaving = true;
        errorMessage = null;

        try
        {
            var url = BuildApiUri("api/integrations/save");
            var response = await Http.PostAsJsonAsync(url, Config);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error saving integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            var saved = await response.Content.ReadFromJsonAsync<IntegrationConfig>();
            if (saved is not null)
            {
                Config = saved;
                Config.Mappings ??= new List<FieldMapping>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while saving integration: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task RunAsync()
    {
        isRunning = true;
        errorMessage = null;

        try
        {
            var url = BuildApiUri("api/integrations/run");
            var response = await Http.PostAsJsonAsync(url, Config);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error running integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            var runResult = await response.Content.ReadFromJsonAsync<RunIntegrationResponse>();

            ApiResult = runResult?.ApiResult;
            MappedJson = runResult?.MappedJson;
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while running integration: {ex.Message}";
        }
        finally
        {
            isRunning = false;
        }
    }
}
