@*
    MappingPanel.razor
    ------------------
    Purpose:
    Displays and edits the collection of field mappings.
    Each mapping links a source JSON path to a target JSON path.

    Parameters:
    - Mappings: The list of FieldMapping items to display and mutate.
    - OnAddMapping: Called when the user requests to add a mapping row.
    - OnRemoveMapping: Called when the user removes a row (index is passed).
*@

@using MIBO.Domain.Models

<div class="panel">
    <div class="panel-header">
        <div>
            <div class="panel-title">Field mappings</div>
            <div class="panel-subtitle">Transform source JSON into target JSON.</div>
        </div>

        <button class="btn-secondary btn-sm"
                @onclick="() => OnAddMapping.InvokeAsync()">
            + Add mapping
        </button>
    </div>

    @if (Mappings is null || Mappings.Count == 0)
    {
        <div class="helper">No mappings yet. Add your first mapping above.</div>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th>Source field</th>
                    <th>Target field</th>
                    <th class="col-narrow"></th>
                </tr>
            </thead>

            <tbody>
            @for (var i = 0; i < Mappings.Count; i++)
            {
                var index = i;
                <tr>
                    <td>
                        <InputText @bind-Value="Mappings[index].SourceField" />
                        <ValidationMessage For="@(() => Mappings[index].SourceField)" />
                    </td>
                    <td>
                        <InputText @bind-Value="Mappings[index].TargetField" />
                        <ValidationMessage For="@(() => Mappings[index].TargetField)" />
                    </td>
                    <td>
                        <div style="display:flex; gap:0.25rem;">
                            <button class="btn-ghost btn-sm"
                                    type="button"
                                    title="Duplicate row"
                                    @onclick="() => DuplicateRow(index)">
                                Duplicate
                            </button>
                            <button class="btn-ghost btn-sm"
                                    type="button"
                                    title="Remove row"
                                    @onclick="() => OnRemoveMapping.InvokeAsync(index)">
                                Remove
                            </button>
                        </div>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter] public List<FieldMapping> Mappings { get; set; } = new();

    [Parameter] public EventCallback OnAddMapping { get; set; }

    [Parameter] public EventCallback<int> OnRemoveMapping { get; set; }

    private void DuplicateRow(int index)
    {
        if (Mappings is null) return;
        if (index < 0 || index >= Mappings.Count) return;

        var original = Mappings[index];

        var clone = new FieldMapping
        {
            SourceField = original.SourceField,
            TargetField = original.TargetField
        };

        Mappings.Insert(index + 1, clone);
        // Blazor ziet de wijziging omdat we aan dezelfde List referentie rommelen
    }
}
