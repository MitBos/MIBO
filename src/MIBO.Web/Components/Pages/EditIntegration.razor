@page "/app/integrations/edit/{Name?}"
@rendermode InteractiveServer

@using MIBO.Domain.Models
@using MIBO.Web.Components.Integration

@inject HttpClient Http
@inject NavigationManager Nav

<h1 class="page-title">Edit integration</h1>
<div class="page-subtitle">
    Configure the source and target calls and define field mappings.
</div>

<div class="mb-3">
    <a href="@AppRoutes.IntegrationsList" class="btn-ghost">
        ‚Üê Back to list
    </a>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

@if (isLoading)
{
    <div>Loading...</div>
}
else
{
    <EditForm EditContext="editContext">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <IntegrationConfigPanel Config="EditorState.Config" />

        <SourceApiPanel Config="EditorState.Config" />

        <TargetApiPanel Config="EditorState.Config" />

        <MappingPanel Mappings="EditorState.Config.Mappings"
                      OnAddMapping="EditorState.AddMapping"
                      OnRemoveMapping="EditorState.RemoveMapping" />

        <div class="mt-3">
            <button type="button"
                    class="btn-secondary"
                    @onclick="SaveAsync"
                    disabled="@isSaving">
                @(isSaving ? "Saving..." : "Save configuration")
            </button>

            <button type="button"
                    class="btn-primary"
                    @onclick="RunAsync"
                    disabled="@isRunning">
                @(isRunning ? "Running..." : "Save & run source call")
            </button>
        </div>
    </EditForm>

    <ApiResultPanel ApiResult="EditorState.ApiResult"
                    MappedJson="EditorState.MappedJson" />
}

@code {
    [Parameter] public string? Name { get; set; }

    [Inject] private IServiceProvider Services { get; set; } = default!;

    private readonly IntegrationEditorState EditorState = new();
    private EditContext? editContext;

    private bool isLoading = true;
    private bool isSaving;
    private bool isRunning;
    private string? errorMessage;

    private Uri BuildApiUri(string relativePath)
    {
        var baseUri = new Uri(Nav.BaseUri);
        return new Uri(baseUri, relativePath.TrimStart('/'));
    }

    protected override async Task OnInitializedAsync()
    {
        var nameToLoad = string.IsNullOrWhiteSpace(Name) ? "NewIntegration" : Name;

        try
        {
            var url = BuildApiUri(ApiRoutes.Integration(nameToLoad));
            var response = await Http.GetAsync(url);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error loading integration '{nameToLoad}': {(int)response.StatusCode} {response.ReasonPhrase}";
                return;
            }

            var loaded = await response.Content.ReadFromJsonAsync<IntegrationConfig>();
            var config = loaded ?? new IntegrationConfig { Name = nameToLoad };

            EditorState.SetConfig(config);
            editContext = new EditContext(EditorState.Config);
            editContext.EnableDataAnnotationsValidation(Services);
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while loading integration '{nameToLoad}': {ex.Message}";
            NotificationService.Instance.ShowError("Load failed", errorMessage);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SaveAsync()
    {
        if (!ValidateForm())
        {
            return;
        }

        isSaving = true;
        errorMessage = null;

        try
        {
            var url = BuildApiUri(ApiRoutes.SaveIntegration);
            var response = await Http.PostAsJsonAsync(url, EditorState.Config);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error saving integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                NotificationService.Instance.ShowError("Save failed", errorMessage);
                return;
            }

            var saved = await response.Content.ReadFromJsonAsync<IntegrationConfig>();
            if (saved is not null)
            {
                EditorState.SetConfig(saved);
                editContext = new EditContext(EditorState.Config);
                editContext.EnableDataAnnotationsValidation(Services);
                NotificationService.Instance.ShowSuccess("Configuration saved", $"Integration '{EditorState.Config.Name}' saved.");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while saving integration: {ex.Message}";
            NotificationService.Instance.ShowError("Save failed", errorMessage);
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task RunAsync()
    {
        if (!ValidateForm())
        {
            return;
        }

        isRunning = true;
        errorMessage = null;

        try
        {
            var url = BuildApiUri(ApiRoutes.RunIntegration);
            var response = await Http.PostAsJsonAsync(url, EditorState.Config);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = $"Error running integration: {(int)response.StatusCode} {response.ReasonPhrase}";
                NotificationService.Instance.ShowError("Run failed", errorMessage);
                return;
            }

            var runResult = await response.Content.ReadFromJsonAsync<RunIntegrationResponse>();

            EditorState.SetResult(runResult);
            NotificationService.Instance.ShowSuccess("Run completed", "Source call executed successfully.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Exception while running integration: {ex.Message}";
            NotificationService.Instance.ShowError("Run failed", errorMessage);
        }
        finally
        {
            isRunning = false;
        }
    }

    private bool ValidateForm()
    {
        if (editContext is null)
        {
            return false;
        }

        var isValid = editContext.Validate();
        if (!EditorState.Validate(out var errors) || !isValid)
        {
            errorMessage = string.Join("; ", errors);
            NotificationService.Instance.ShowWarning("Please fix validation errors", errorMessage);
            return false;
        }

        errorMessage = null;
        return true;
    }
}
